<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>Agar Mobile (Somente Celular) + Skins (12)</title>
  <style>
    html,body{
      margin:0;height:100%;background:#000;overflow:hidden;
      font-family:system-ui, -apple-system, Arial, sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      touch-action:none;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    #gameContainer{position:relative;width:100vw;height:100vh;background:linear-gradient(45deg,#001122 0%,#003344 100%)}
    #gameCanvas{display:block;width:100%;height:100%;touch-action:none}
    .hidden{display:none!important}

    /* HUD */
    #ui{
      position:absolute;left:10px;top:10px;z-index:10;color:#fff;
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:12px; padding:10px 14px; font-weight:700;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }

    /* Start */
    #start{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:20;
      background: linear-gradient(135deg, #0c1445 0%, #1a2980 50%, #26467c 100%);
    }
    #start .container{ width:min(560px,94vw); text-align:center; }
    #start .logo{ font-size:2.2em; font-weight:900; color:#fff; margin-bottom:10px;
      text-shadow:0 0 22px rgba(0,255,170,.6), 0 2px 4px rgba(0,0,0,.3);
    }

    .section{background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22);
      border-radius:12px; padding:14px; margin:10px 0; color:#fff;
    }
    .section h3{margin:0 0 8px 0;font-size:16px;letter-spacing:.4px}

    /* Dificuldade */
    .difficultyBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .diffBtn{flex:1;min-width:90px;height:56px;border-radius:10px;border:2px solid;cursor:pointer;font-weight:700}
    .diffBtn[data-difficulty="easy"]{border-color:#4CAF50;color:#4CAF50;background:rgba(76,175,80,.12)}
    .diffBtn[data-difficulty="normal"]{border-color:#FF9800;color:#FF9800;background:rgba(255,152,0,.12)}
    .diffBtn[data-difficulty="hard"]{border-color:#F44336;color:#F44336;background:rgba(244,67,54,.12)}
    .diffBtn.active{color:#000 !important;background:#fff !important;transform:scale(1.02)}

    /* Skins */
    .skinsGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
    .skinBtn{aspect-ratio:1/1;border:2px solid rgba(255,255,255,.25);border-radius:10px;background:rgba(255,255,255,.12);
      color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;overflow:hidden; position:relative;}
    .skinBtn.active{outline:3px solid #00ffaa;border-color:#00ffaa;box-shadow:0 0 18px rgba(0,255,170,.5)}
    .skinPreview{width:100%;height:100%;object-fit:cover;pointer-events:none}
    .skinEmoji{font-size:28px}

    /* Bot√µes */
    .mainBtns{display:flex;justify-content:center;gap:16px;margin-top:10px}
    .mainBtn{flex:1;min-width:140px;height:56px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
    .solo{background:#00ff88;color:#000}
    .online{background:#ff6b6b;color:#fff}

    /* Over */
    #over{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:25}
    #over .box{width:min(420px,92vw); background:rgba(255,255,255,0.1);
      backdrop-filter:blur(30px); -webkit-backdrop-filter:blur(30px);
      border:1px solid rgba(255,102,102,0.3); color:#fff; border-radius:20px;
      padding:20px; text-align:center; box-shadow:0 16px 40px rgba(0,0,0,0.4);
    }
    #over button{padding:12px 20px;border-radius:12px;border:none;background:rgba(0,255,136,0.9);font-weight:800;cursor:pointer}

    /* Minimap + Status */
    #minimapWrap{position:absolute;right:10px;top:10px;z-index:12;background:rgba(255,255,255,0.1);
      border:1px solid rgba(0,255,170,0.3);border-radius:12px;padding:6px}
    #minimap{display:block;width:160px;height:120px;border-radius:8px}

    /* Mobile buttons */
    #mobileBtns{position:absolute;right:10px;bottom:10px;z-index:15;display:flex;gap:8px}
    #mobileBtns button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff;font-weight:800}

    /* Overlay Desktop */
    #desktopBlock{
      position:fixed; inset:0; background:#0b142e; color:#fff; display:none; align-items:center; justify-content:center;
      text-align:center; padding:20px; z-index:9999;
    }
    #desktopBlock .box{
      max-width:560px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
      border-radius:16px; padding:20px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>

    <div id="ui" class="hidden">Pontua√ß√£o: <b id="score">0</b> ‚Ä¢ Massa: <b id="mass">10</b></div>

    <div id="start">
      <div class="container">
        <div class="logo">ü¶† AGAR MOBILE</div>

        <!-- Dificuldade -->
        <div class="section">
          <h3>Dificuldade</h3>
          <div class="difficultyBtns">
            <button class="diffBtn active" data-difficulty="easy">F√°cil</button>
            <button class="diffBtn" data-difficulty="normal">Normal</button>
            <button class="diffBtn" data-difficulty="hard">Dif√≠cil</button>
          </div>
        </div>

        <!-- Skins -->
        <div class="section" id="skinsSection">
          <h3>Skins (escolha uma)</h3>
          <div class="skinsGrid" id="skinsGrid">
            <!-- Thumbnails ser√£o gerados via JS a partir do kirby.png + emojis -->
          </div>
          <div style="opacity:.85;margin-top:8px;font-size:12px">Dica: mantenha <b>kirby.png</b> na mesma pasta do index.</div>
        </div>

        <div class="mainBtns">
          <button class="mainBtn solo" id="btnStart">JOGAR</button>
          <button class="mainBtn online" disabled title="Em breve">ONLINE</button>
        </div>
      </div>
    </div>

    <div id="over" class="hidden">
      <div class="box">
        <h2>üíÄ Game Over</h2>
        <p>Pontua√ß√£o: <b id="finalScore">0</b> ‚Ä¢ Massa: <b id="finalMass">0</b></p>
        <button id="btnRestart">Jogar novamente</button>
      </div>
    </div>

    <div id="minimapWrap" class="hidden"><canvas id="minimap" width="160" height="120"></canvas></div>

    <div id="mobileBtns" class="hidden">
      <button id="btnEject">EJETAR</button>
      <button id="btnSplit">DIVIDIR</button>
    </div>
  </div>

  <!-- Overlay Desktop -->
  <div id="desktopBlock">
    <div class="box">
      <h2>üì± Dispon√≠vel apenas em CELULAR por enquanto</h2>
      <p>Abra essa p√°gina em um smartphone (iOS/Android). Em breve liberamos para outras plataformas.</p>
    </div>
  </div>

<script>
/* ===== Bloqueio de desktop / sem toque ===== */
(function(){
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const isSmall = Math.min(window.innerWidth, window.innerHeight) < 900;
  if(!(isTouch && isSmall)){
    document.getElementById('desktopBlock').style.display='flex';
  }
})();

/* ===== Evita rolagem/pinch no mobile ===== */
document.addEventListener('touchmove', (e)=>{ if (window.__GAME_RUNNING__) e.preventDefault(); }, {passive:false});
document.addEventListener('gesturestart', (e)=> e.preventDefault());

/* ===== Canvas ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mini = document.getElementById('minimap');
const mctx = mini.getContext('2d');
const ui = document.getElementById('ui');
const startPane = document.getElementById('start');
const overPane = document.getElementById('over');
const minimapWrap = document.getElementById('minimapWrap');
const mobileBtns = document.getElementById('mobileBtns');

let W = innerWidth, H = innerHeight, DPR = Math.min(3, (window.devicePixelRatio||1));
function fit(){ W = innerWidth; H = innerHeight; DPR = Math.min(3, (window.devicePixelRatio||1)); canvas.width = W * DPR; canvas.height = H * DPR; ctx.setTransform(DPR,0,0,DPR,0,0); }
addEventListener('resize', fit, {passive:true}); fit();

/* ===== World ===== */
const WORLD_W = 2400, WORLD_H = 1800;
const FRUITS = ['üçé','üçå','üçá','üçì','üçä'];

let gameRunning=false, score=0;
let player, enemies=[], food=[], particles=[];
let camera={x:WORLD_W/2,y:WORLD_H/2,zoom:1};
let moveTarget=null;

/* ===== Skins ===== */
const skinsGrid = document.getElementById('skinsGrid');
const kirbyImg = new Image();
kirbyImg.src = 'kirby.png';

let selectedSkin = { type:'emoji', value:'üêâ' }; // fallback

function chooseTileSize(w,h){
  // pick a square size between 12..64 that divides both and yields 8..20 columns
  let best=null;
  for(let s=12;s<=64;s++){
    if(w%s===0 && h%s===0){
      const cols=w/s, rows=h/s;
      if(cols>=8 && cols<=20 && rows>=8){
        best=s; break;
      }
    }
  }
  // fallback guess 18 or min
  if(!best){
    if(w%18===0 && h%18===0) best=18;
    else best = Math.min(w,h)/Math.floor(Math.min(w,h)/18)||18;
  }
  return Math.floor(best);
}

function makeThumbFromSprite(col,row,tile){
  const c=document.createElement('canvas'); c.width=64; c.height=64;
  const g=c.getContext('2d');
  g.imageSmoothingEnabled=false;
  g.drawImage(kirbyImg, col*tile, row*tile, tile, tile, 0, 0, 64, 64);
  return c.toDataURL();
}

function buildSkinsUIFromSprite(){
  const w=kirbyImg.naturalWidth, h=kirbyImg.naturalHeight;
  const tile=chooseTileSize(w,h);
  const cols=w/tile, rows=h/tile;

  // Usar a PRIMEIRA LINHA e pegar 12 colunas (ou menos se n√£o houver)
  const take=Math.min(12, cols);
  for(let c=0;c<take;c++){
    const btn=document.createElement('button');
    btn.className='skinBtn'+(c===0?' active':'');
    const img=document.createElement('img');
    img.className='skinPreview';
    img.src=makeThumbFromSprite(c,0,tile);
    btn.appendChild(img);
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.skinBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedSkin = { type:'sprite', col:c, row:0, tile };
    });
    skinsGrid.appendChild(btn);
    if(c===0){ selectedSkin = { type:'sprite', col:0, row:0, tile }; }
  }

  // Adicionar 3 emojis extras no fim
  ['üëë','üî•','‚ö°'].forEach(em=>{
    const btn=document.createElement('button');
    btn.className='skinBtn';
    const span=document.createElement('span');
    span.className='skinEmoji';
    span.textContent=em;
    btn.appendChild(span);
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.skinBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedSkin = { type:'emoji', value: em };
    });
    skinsGrid.appendChild(btn);
  });
}

kirbyImg.onload = () => {
  try{ buildSkinsUIFromSprite(); }
  catch(e){
    // Se der algum erro, cai para emojis
    buildEmojiOnly();
  }
};
kirbyImg.onerror = buildEmojiOnly;

function buildEmojiOnly(){
  skinsGrid.innerHTML='';
  ['üêâ','üëë','üî•','‚ö°','üßø','üê≤','ü¶à','üê∫','ü¶Ö','üõ°Ô∏è','üéØ','üíé'].forEach((em,i)=>{
    const btn=document.createElement('button');
    btn.className='skinBtn'+(i===0?' active':'');
    const span=document.createElement('span'); span.className='skinEmoji'; span.textContent=em; btn.appendChild(span);
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.skinBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      selectedSkin = { type:'emoji', value: em };
    });
    skinsGrid.appendChild(btn);
    if(i===0){ selectedSkin = { type:'emoji', value: em }; }
  });
}

/* ===== Difficulty ===== */
let currentDifficulty = 'easy';
document.querySelectorAll('.diffBtn').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.diffBtn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentDifficulty = b.dataset.difficulty;
  });
});

/* ===== Utils ===== */
function massToRadius(m){ return Math.sqrt(Math.max(0.0001,m))*2+5; }
function speedFromRadius(r){ return 12/Math.sqrt(r+30); }

/* ===== Gameplay ===== */
function reset(){
  let foodCount = currentDifficulty==='hard'?250: (currentDifficulty==='normal'?320:400);
  let enemyCount = currentDifficulty==='hard'?35: (currentDifficulty==='normal'?25:15);
  let startMass = currentDifficulty==='hard'?10: (currentDifficulty==='normal'?12:18);

  player={ x:WORLD_W/2, y:WORLD_H/2, mass:startMass, radius:massToRadius(startMass), vx:0, vy:0, split:false, splitBalls:[] };
  enemies=[]; food=[]; particles=[];

  for(let i=0;i<foodCount;i++){ food.push({x:Math.random()*WORLD_W,y:Math.random()*WORLD_H,radius:10,emoji:FRUITS[(Math.random()*FRUITS.length)|0]}); }
  for(let i=0;i<enemyCount;i++){ enemies.push({x:Math.random()*WORLD_W,y:Math.random()*WORLD_H,mass:20+Math.random()*50,radius:0,vx:0,vy:0}); enemies[i].radius=massToRadius(enemies[i].mass); }
}
function startGame(){
  reset();
  gameRunning=true; window.__GAME_RUNNING__=true;
  score=0; moveTarget=null;
  startPane.classList.add('hidden'); overPane.classList.add('hidden');
  ui.classList.remove('hidden'); minimapWrap.classList.remove('hidden'); mobileBtns.classList.remove('hidden');
  requestAnimationFrame(loop);
}
function endGame(){
  gameRunning=false; window.__GAME_RUNNING__=false;
  document.getElementById('finalScore').textContent = score;
  document.getElementById('finalMass').textContent = Math.floor(player.mass);
  overPane.classList.remove('hidden');
  ui.classList.add('hidden'); minimapWrap.classList.add('hidden'); mobileBtns.classList.add('hidden');
  startPane.classList.remove('hidden');
}

/* ===== Controls (touch) ===== */
canvas.addEventListener('touchstart', e=>{
  const t=e.changedTouches[0];
  moveTarget={x:(t.clientX),y:(t.clientY)};
});
canvas.addEventListener('touchmove', e=>{
  const t=e.changedTouches[0];
  moveTarget={x:(t.clientX),y:(t.clientY)};
});
canvas.addEventListener('touchend', ()=>{ moveTarget=null; });

document.getElementById('btnStart').addEventListener('click', startGame);
document.getElementById('btnRestart').addEventListener('click', startGame);
document.getElementById('btnSplit').addEventListener('click', ()=>{ if(!player.split){ doSplit(); } });
document.getElementById('btnEject').addEventListener('click', ()=>{ ejectMass(); });

/* ===== Mechanics ===== */
function doSplit(){
  if(player.mass<20) return;
  const half=player.mass/2;
  const angle = moveTarget? Math.atan2(moveTarget.y - H/2, moveTarget.x - W/2) : Math.random()*Math.PI*2;
  const speed=9;
  const sx = Math.cos(angle)*speed, sy=Math.sin(angle)*speed;
  const ball={x:player.x+Math.cos(angle)*player.radius, y:player.y+Math.sin(angle)*player.radius, mass:half, radius:massToRadius(half), vx:sx, vy:sy, life:120};
  player.mass = half;
  player.radius = massToRadius(player.mass);
  player.splitBalls.push(ball);
}

function ejectMass(){
  if(player.mass<10) return;
  const ang = moveTarget? Math.atan2(moveTarget.y - H/2, moveTarget.x - W/2) : Math.random()*Math.PI*2;
  const speed=6;
  const px = player.x + Math.cos(ang)*(player.radius+8);
  const py = player.y + Math.sin(ang)*(player.radius+8);
  particles.push({x:px,y:py,vx:Math.cos(ang)*speed,vy:Math.sin(ang)*speed,radius:6,life:240,edible:true});
  player.mass -= 2; player.radius = massToRadius(player.mass);
}

/* ===== Rendering ===== */
function drawPlayerSkin(x,y,r){
  if(selectedSkin.type==='emoji'){
    ctx.font = `${r*1.4}px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, Arial`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(selectedSkin.value, x, y);
  } else if(selectedSkin.type==='sprite' && kirbyImg.complete){
    const t=selectedSkin.tile, sx=selectedSkin.col*t, sy=selectedSkin.row*t;
    ctx.imageSmoothingEnabled=false;
    ctx.drawImage(kirbyImg, sx, sy, t, t, x-r, y-r, r*2, r*2);
  } else {
    // fallback c√≠rculo
    ctx.fillStyle='#39f'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }
}

function render(){
  ctx.clearRect(0,0,W,H);

  // Camera segue player
  camera.x = player.x; camera.y = player.y;
  const offX = W/2 - camera.x;
  const offY = H/2 - camera.y;

  // fundo quadriculado
  ctx.save();
  ctx.translate(offX,offY);
  ctx.fillStyle='#001822'; ctx.fillRect(-200,-200,WORLD_W+400,WORLD_H+400);
  ctx.strokeStyle='rgba(255,255,255,.06)';
  for(let x=0;x<=WORLD_W;x+=100){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,WORLD_H); ctx.stroke(); }
  for(let y=0;y<=WORLD_H;y+=100){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(WORLD_W,y); ctx.stroke(); }

  // food
  ctx.textAlign='center'; ctx.textBaseline='middle';
  for(const f of food){
    ctx.font='16px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji';
    ctx.fillText(f.emoji, f.x, f.y);
  }

  // particles
  for(const p of particles){
    ctx.fillStyle='rgba(0,255,155,.8)';
    ctx.beginPath(); ctx.arc(p.x,p.y,p.radius,0,Math.PI*2); ctx.fill();
  }

  // enemies
  ctx.fillStyle='rgba(255,80,80,.9)';
  enemies.forEach(en=>{
    ctx.beginPath(); ctx.arc(en.x,en.y,en.radius,0,Math.PI*2); ctx.fill();
  });

  // player + splits
  drawPlayerSkin(player.x, player.y, player.radius);
  player.splitBalls.forEach(b=>{ drawPlayerSkin(b.x,b.y,b.radius); });

  ctx.restore();

  // UI
  document.getElementById('score').textContent = score;
  document.getElementById('mass').textContent = Math.floor(player.mass);
}

function update(){
  // mover player em dire√ß√£o ao dedo
  if(moveTarget){
    const ang = Math.atan2(moveTarget.y - H/2, moveTarget.x - W/2);
    const spd = speedFromRadius(player.radius);
    player.vx = Math.cos(ang)*spd; player.vy = Math.sin(ang)*spd;
  }else{ player.vx*=0.9; player.vy*=0.9; }

  player.x += player.vx; player.y += player.vy;
  player.x = Math.max(player.radius, Math.min(WORLD_W - player.radius, player.x));
  player.y = Math.max(player.radius, Math.min(WORLD_H - player.radius, player.y));

  // split balls
  player.splitBalls.forEach(b=>{
    b.x += b.vx; b.y += b.vy; b.vx*=0.96; b.vy*=0.96;
    b.life--; if(b.life<=0){
      player.mass += b.mass; player.radius = massToRadius(player.mass);
      b._dead=true;
    }
  });
  player.splitBalls = player.splitBalls.filter(b=>!b._dead);

  // coletar foods
  for(const f of food){
    const dx=f.x-player.x, dy=f.y-player.y, d2=dx*dx+dy*dy;
    if(d2 < (player.radius+10)*(player.radius+10)){
      f._dead=true; player.mass+=1; player.radius=massToRadius(player.mass); score+=1;
    }
    for(const b of player.splitBalls){
      const dx2=f.x-b.x, dy2=f.y-b.y, d22=dx2*dx2+dy2*dy2;
      if(d22 < (b.radius+10)*(b.radius+10)){ f._dead=true; b.mass+=1; b.radius=massToRadius(b.mass); score+=1; }
    }
  }
  food = food.filter(f=>!f._dead);
  while(food.length<300){ food.push({x:Math.random()*WORLD_W,y:Math.random()*WORLD_H,radius:10,emoji:FRUITS[(Math.random()*FRUITS.length)|0]}); }

  // colis√£o enemies simples
  enemies.forEach(en=>{
    // perseguir levemente
    const ang = Math.atan2(player.y-en.y, player.x-en.x);
    en.vx = Math.cos(ang)*0.5; en.vy = Math.sin(ang)*0.5;
    en.x+=en.vx; en.y+=en.vy;

    const dx=en.x-player.x, dy=en.y-player.y;
    const dist=Math.hypot(dx,dy);
    if(dist < en.radius - player.radius*0.6 && en.mass > player.mass*1.3){
      endGame();
    }
    if(dist < player.radius - en.radius*0.6 && player.mass > en.mass*1.3){
      en._dead=true; player.mass += en.mass*0.6; player.radius = massToRadius(player.mass); score += Math.floor(en.mass);
    }
  });
  enemies = enemies.filter(e=>!e._dead);
  while(enemies.length< (currentDifficulty==='hard'?35: (currentDifficulty==='normal'?25:15)) ){
    const m=20+Math.random()*50; enemies.push({x:Math.random()*WORLD_W,y:Math.random()*WORLD_H,mass:m,radius:massToRadius(m),vx:0,vy:0});
  }
}

function loop(){
  if(!gameRunning) return;
  update(); render();
  requestAnimationFrame(loop);
}

/* ===== Minimap (opcional simples) ===== */
function renderMinimap(){
  mctx.clearRect(0,0,mini.width,mini.height);
}
setInterval(renderMinimap, 300);

/* ===== Start ===== */
document.getElementById('btnStart').addEventListener('click', startGame);
document.getElementById('btnRestart').addEventListener('click', startGame);
</script>
</body>
</html>
